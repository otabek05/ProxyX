import{r as l,u as te,d as V,f as $,a as se,j as e,B as u,T as v,M as K,b as ae,I as ne,c as z,K as U,A as _,S as H,C as G,e as le,g as re,h as oe,s as ie,i as ce,k as J,l as de,D as ue,m as me,n as he,o as X,p as xe,q as pe,R as ge,t as L,v as fe,w as je,x as ye,y as ve,z as Y,E as o,F as f,G as Se,H as j,L as be,J as Q,N as Ie,O as we,P as Ce,Q as De,U as Ee}from"./index-C1FOain-.js";function Te({onClose:I}){const[D,A]=l.useState(""),[w,E]=l.useState([]),[C,h]=l.useState([]),[d,m]=l.useState([]),[T,N]=l.useState(null),[S,B]=l.useState(null),[P,W]=l.useState(""),{showSnackbar:g}=te(),[n,x]=l.useState({name:"",address:"",memo:"",contractEndDate:V().format("YYYY-MM-DD"),contractStartDate:V().format("YYYY-MM-DD"),deviceId:0,installationId:0,receiverType:"P형",employeeNames:[],clientNames:[]}),[r,y]=l.useState({});l.useEffect(()=>{M(),s()},[]);const p=t=>{const{name:a,value:i}=t.target;x(c=>({...c,[a]:i})),y(c=>({...c,[a]:void 0}))},R=(t,a)=>{const i=Array.from(new Set(a));x(c=>({...c,employeeNames:i})),y(c=>({...c,employeeNames:void 0}))},O=t=>{x(a=>({...a,employeeNames:a.employeeNames.filter(i=>i!==t)}))},k=(t,a)=>{console.log(a);const i=Array.from(new Set(a));x(c=>({...c,clientNames:i})),y(c=>({...c,clientNames:void 0}))},F=t=>{x(a=>({...a,clientNames:a.clientNames.filter(i=>i!==t)}))},M=async()=>{const t=await $();E(t)},s=async()=>{const t=await se();m(t)},b=async()=>{if(!P?.trim()){g("장치 번호를 입력해주세요.","error");return}const t=await le(P);if(t instanceof Error){g("서버 오류가 발생했습니다. 다시 시도해주세요.","error");return}if(t.isDeviceInUse){g("이미 사용 중인 장치입니다.","warning");return}g("사용 가능한 장치입니다.","success"),y(a=>({...a,deviceId:void 0})),x(a=>({...a,deviceId:t.id})),B(t)},q=async t=>{const a={search:t,status:re.ACTIVE,size:5},i=await oe(a);if(i instanceof Error){g("서버 오류가 발생했습니다. 다시 시도해주세요.","error");return}h(i.content)},Z=()=>{const t={};n.name.trim()||(t.name="이름은 필수 입력 항목입니다."),n.address.trim()||(t.address="주소는 필수 입력 항목입니다."),n.contractStartDate||(t.contractStartDate="계약 시작일을 선택해주세요."),n.contractEndDate||(t.contractEndDate="계약 종료일을 선택해주세요."),(!n.installationId||n.installationId===0)&&(t.installationId="관리 구역을 선택해주세요."),n.receiverType||(t.receiverType="수신기형을 선택해주세요."),S||(t.deviceId="장치 확인이 필요합니다."),(!n.employeeNames||n.employeeNames.length===0)&&(t.employeeNames="담당자를 한 명 이상 선택해주세요."),(!n.clientNames||n.clientNames.length===0)&&(t.clientNames="건물 관리자를 한 명 이상 선택해주세요.");const a=[];return n.employeeNames.forEach((i,c)=>{i.trim()?a[c]="":a[c]="빈 이름은 허용되지 않습니다."}),a.some(i=>i)&&(t.employeeNames=a),y(t),Object.keys(t).length===0},ee=async t=>{if(t.preventDefault(),!Z()){g("모든 필드를 올바르게 입력해주세요.","error");return}await ie(n),I()};return e.jsx(u,{maxWidth:"lg",sx:{p:3},children:e.jsxs("form",{onSubmit:ee,noValidate:!0,children:[e.jsxs(u,{display:"flex",gap:2,flexWrap:"wrap",mb:2,children:[e.jsx(v,{label:"주소",name:"address",value:n.address,onChange:p,error:!!r.address,helperText:r.address,required:!0,variant:"outlined",sx:{flex:"1 1 45%"}}),e.jsx(v,{label:"이름",sx:{flex:"1 1 45%"},name:"name",value:n.name,onChange:p,error:!!r.name,helperText:r.name,required:!0,variant:"outlined"})]}),e.jsxs(u,{display:"flex",flexWrap:"wrap",gap:2,mb:2,children:[e.jsx(v,{select:!0,name:"installationId",label:"관리 구역",value:T?.address,onChange:t=>{p(t),N(d.filter(a=>a.id===Number(t.target.value))[0])},error:!!r.installationId,helperText:r.installationId,required:!0,margin:"normal",variant:"outlined",sx:{flex:"1 1 45%"},children:d.map(t=>e.jsx(K,{value:t.id,children:t.address},t.id))}),e.jsx(v,{select:!0,label:"수신기형",name:"receiverType",value:n.receiverType,onChange:p,error:!!r.receiverType,helperText:r.receiverType,required:!0,margin:"normal",variant:"outlined",sx:{flex:"1 1 45%"},children:ae.map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(v,{fullWidth:!0,label:"장치 번호",name:"deviceId",value:S?.macAddress,onChange:t=>W(t.target.value),margin:"normal",variant:"outlined",error:!!r.deviceId,helperText:r.deviceId,disabled:S!==null,slotProps:{input:{endAdornment:e.jsx(ne,{position:"end",children:e.jsx(z,{disabled:S!==null,onClick:b,children:S!==null?"확인 완료":"확인"})})}}}),e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",py:2},children:[e.jsx(U,{label:"계약 시작일",size:"medium",fullWidth:!0,setValue:t=>x(a=>({...a,contractStartDate:t})),value:n.contractStartDate,sx:{pr:1}}),e.jsx(U,{label:"계약 종료일",size:"medium",fullWidth:!0,setValue:t=>x(a=>({...a,contractEndDate:t})),value:n.contractEndDate,sx:{pl:1}})]}),e.jsx(e.Fragment,{children:e.jsxs(u,{mb:3,children:[e.jsx(_,{multiple:!0,options:w.map(t=>t.name),value:n.employeeNames,onChange:R,renderInput:t=>e.jsx(v,{...t,label:"관리대행 담당자 선택",variant:"outlined",fullWidth:!0,error:!!r.employeeNames,helperText:r.employeeNames}),renderTags:()=>null}),e.jsx(H,{direction:"row",spacing:1,mt:1,flexWrap:"wrap",children:n.employeeNames.map(t=>e.jsx(G,{label:t,onDelete:()=>O(t),color:"default",sx:{mb:0}},t))})]})}),e.jsxs(u,{mb:1,children:[e.jsx(_,{multiple:!0,options:C.map(t=>t.name),value:n.clientNames,onChange:k,renderInput:t=>e.jsx(v,{...t,label:"건물 관리자 (이름 또는 전화번호로 검색)",variant:"outlined",fullWidth:!0,onChange:a=>{q(a.target.value)},error:!!r.clientNames,helperText:r.clientNames}),renderTags:()=>null}),e.jsx(H,{direction:"row",spacing:1,mt:1,flexWrap:"wrap",children:n.clientNames.map(t=>e.jsx(G,{label:t,onDelete:()=>F(t),color:"default",sx:{mb:0}},t))})]}),e.jsx(v,{fullWidth:!0,multiline:!0,rows:3,label:"메모",name:"memo",value:n.memo,onChange:p,margin:"normal",variant:"outlined"}),e.jsx(z,{variant:"contained",type:"submit",fullWidth:!0,size:"large",children:"등록하기"})]})})}function Ne({totalBuildings:I,loadBuildings:D}){const[A,w]=l.useState(!1),[E,C]=l.useState(!1),h=()=>w(!0),d=()=>w(!1),m=()=>{D(),d()};return e.jsxs(e.Fragment,{children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:0,borderRadius:2},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:1,mr:2,bgcolor:"grey.200",borderRadius:1,py:1,px:2},children:[e.jsx(ce,{sx:{bgcolor:"primary.main",width:30,height:30},children:e.jsx(J,{icon:"mdi:office-building",width:20,height:20})}),e.jsxs(de,{variant:"h6",component:"div",children:["총 건물 수: ",I]})]}),e.jsx(H,{direction:"row",spacing:1,children:e.jsx(z,{variant:"contained",startIcon:e.jsx(J,{icon:"mdi:plus",width:20,height:20}),onClick:()=>{C(!0),h()},children:"건물 등록"})})]}),e.jsxs(ue,{open:A,onClose:d,fullWidth:!0,maxWidth:E&&"lg",children:[e.jsxs(me,{sx:{m:0,p:2},children:["건물 등록",e.jsx(he,{"aria-label":"close",onClick:d,sx:{position:"absolute",right:8,top:8,color:T=>T.palette.grey[500]},children:e.jsx(X,{icon:"solar:close-square-bold",width:30,height:30})})]}),e.jsx(xe,{dividers:!0,children:e.jsx(Te,{onClose:m})})]})]})}function Be(){const[I,D]=l.useState([]),[A,w]=l.useState([]),[E,C]=l.useState(!1),[h,d]=l.useState(Number(sessionStorage.getItem("buildingPage"))??0),[m,T]=l.useState(Number(sessionStorage.getItem("buildingRows")??10)),[N,S]=l.useState("asc"),[B,P]=l.useState("createdAt"),[W,g]=l.useState(0),[n,x]=l.useState("전체"),[r,y]=l.useState(sessionStorage.getItem("buildingSearch")??""),[p,R]=l.useState(""),O=l.useRef(null),k=async()=>{C(!0);try{const s={page:h,size:m,search:r||void 0,sortBy:B,sortOrder:N,employeeId:n==="전체"?null:Number(n),buildingType:null};console.log("Params: ",s);const b=n==="전체"?await De(s):await Ee(s.employeeId,s.page,s.size,s.search,s.sortBy,s.sortOrder);if(b instanceof Error)return;const q=b.content;D(q),g(b.page.totalElements)}catch{D([]),g(0)}finally{C(!1)}};l.useEffect(()=>{sessionStorage.setItem("buildingPage",h.toString()),sessionStorage.setItem("buildingRows",m.toString()),sessionStorage.setItem("buildingSearch",r)},[h,m,r]),l.useEffect(()=>{k()},[r,h,m,B,N,n]),l.useEffect(()=>{p===""&&y("")},[p]);const F=()=>{y(p),d(0)};l.useEffect(()=>{M()},[]);async function M(){const s=await $();w(s)}return e.jsxs(u,{sx:{p:2},children:[e.jsxs(u,{sx:{display:"flex",flexWrap:"wrap",justifyContent:"space-between",gap:1,mb:2},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(pe,{value:p,onChange:R,onSearch:F}),e.jsx(ge,{value:m,onChange:s=>{T(s),d(0)}}),e.jsx(L,{label:"담당자",value:n??"",options:[{label:"전체",value:"전체"},...A.map(s=>({label:s.name,value:String(s.id)}))],onChange:s=>{d(0),x(s)}}),e.jsx(L,{label:"정렬 기준",value:B,options:fe,onChange:s=>{d(0),P(s)}}),e.jsx(L,{label:"정렬 순서",value:N,options:je,onChange:s=>{S(s),d(0)}})]}),e.jsx(Ne,{totalBuildings:W,loadBuildings:k})]}),e.jsx(u,{ref:O,sx:{maxHeight:"74vh",overflow:"auto"},children:e.jsxs(ye,{children:[e.jsx(ve,{children:e.jsxs(Y,{sx:{backgroundColor:"grey.100"},children:[e.jsx(o,{sx:{...f,width:40},children:"NO"}),e.jsx(o,{sx:{...f,width:200,textAlign:"start"},children:"건물명"}),e.jsx(o,{sx:{...f,width:280,textAlign:"start"},children:"주소"}),e.jsx(o,{sx:{...f,width:160},children:"수신기 종류"}),e.jsx(o,{sx:{...f,width:180},children:"장치 번호"}),e.jsx(o,{sx:{...f,width:160},children:"계약 시작일"}),e.jsx(o,{sx:{...f,width:160},children:"계약 종료일"}),e.jsx(o,{sx:{...f,width:160},children:"등록일"}),e.jsx(o,{sx:{...f,width:160},children:"장치 연결"})]})}),e.jsxs(Se,{children:[I.length===0&&!E&&e.jsx(Y,{children:e.jsx(o,{colSpan:8,align:"center",sx:{py:4},children:"조회된 건물이 없습니다."})}),I.map((s,b)=>e.jsxs(Y,{hover:!0,children:[e.jsx(o,{sx:j,children:h*m+b+1}),e.jsx(o,{sx:j,children:e.jsxs(be,{to:`/buildings/${s.id}`,style:{display:"flex",alignItems:"center",gap:"0.4rem",textDecoration:"none",color:"inherit"},children:[e.jsx(Q,{text:s.name,search:r}),e.jsx(X,{icon:"mdi:link",width:18,height:18})]})}),e.jsx(o,{sx:{...j,textAlign:"start"},children:e.jsx(Q,{text:s.address,search:r})}),e.jsx(o,{sx:j,children:s.receiverType??"-"}),e.jsx(o,{sx:j,children:s.macAddress??"-"}),e.jsx(o,{sx:j,children:s.contractStartDate?new Date(s.contractStartDate).toLocaleDateString():"-"}),e.jsx(o,{sx:j,children:s.contractEndDate?new Date(s.contractEndDate).toLocaleDateString():"-"}),e.jsx(o,{sx:j,children:s.createdAt?new Date(s.createdAt).toLocaleDateString():"-"}),e.jsx(o,{sx:j,children:e.jsx(Ie,{buildingId:s.id,dialogComponent:!0})})]},s.id))]})]})}),e.jsx(u,{sx:{mt:1,display:"flex",justifyContent:"center"},children:e.jsx(we,{totalElements:W,onPageChange:d,rowsPerPage:m,page:h})}),e.jsx(Ce,{scrollContainerRef:O,scrollThreshold:150})]})}function Pe(){return e.jsx(e.Fragment,{children:e.jsx(Be,{})})}export{Pe as default};
